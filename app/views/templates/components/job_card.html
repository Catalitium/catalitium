{# Job Card Partial (clean, DB-first, ASCII-safe) #}
{# Use currency codes (short labels) instead of symbols for a cleaner UI #}
{% set CUR = {'EUR':'EUR','USD':'USD','GBP':'GBP','CHF':'CHF'} %}
{% set desc_clean = (j.description or '')|replace('LinkedIn','')|replace('linkedin','')|replace('LINKEDIN','') %}
<article
  class="rounded-xl border border-slate-200 bg-white p-3 sm:p-4 hover:border-slate-300 transition-colors motion-safe:transition-transform motion-safe:duration-150 hover:shadow-md hover:-translate-y-[1px] active:translate-y-px"
  data-job-id="{{ j.id }}"
  data-job-title="{{ (j.title or '')|e }}"
  data-job-company="{{ (j.company or '')|e }}"
  data-job-location="{{ (j.location or 'Remote / Anywhere')|e }}"
  data-job-summary="{{ desc_clean|replace('\n', ' ')|truncate(200, True)|e }}"
  data-job-date="{{ j.date_raw or '' }}"
>
  <header class="flex flex-col sm:flex-row items-start justify-between gap-2 sm:gap-3">
    <div class="min-w-0">
      <div class="flex items-center gap-2 flex-wrap">
        <h2 class="text-lg sm:text-xl font-semibold leading-snug clamp-2 sm:clamp-1 break-words">
          <a href="{{ url_for('job_detail', job_id=j.id) }}" class="hover:text-brand transition-colors focus-visible:outline-none focus-visible:underline">{{ j.title }}</a>
        </h2>
        {% if j.is_new %}
        <span class="inline-flex items-center gap-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-700 bg-emerald-100 border border-emerald-200 rounded-full px-2 py-0.5">New</span>
        {% endif %}
        {% if j.is_ghost %}
        <span class="inline-flex items-center gap-1 text-[11px] font-medium text-slate-500 bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5" title="Posted over 30 days ago — may already be filled">
          <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 9v4M12 17h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          May be filled
        </span>
        {% endif %}
      </div>

      <div class="mt-1 flex flex-wrap items-center gap-2 text-xs sm:text-[13px] text-slate-700" data-job-meta="true">
        {% if j.company %}
        <span class="inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-2 py-1">
          <svg class="w-3.5 h-3.5 text-slate-500" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 7h14M5 12h14M5 17h14" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
          <span>{{ j.company }}</span>
        </span>
        {% endif %}
        <span class="inline-flex items-center gap-1 rounded-full bg-sky-50 border border-sky-200 px-2 py-1 text-sky-800">
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 21s7-5.5 7-11.2A7 7 0 0012 3a7 7 0 00-7 6.8C5 15.5 12 21 12 21z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/><circle cx="12" cy="10" r="2.5" stroke="currentColor" stroke-width="1.1"/></svg>
          <span>{{ j.location or 'Remote / Anywhere' }}</span>
        </span>
        {% if j.date_posted %}
        <span class="inline-flex items-center gap-1 rounded-full bg-indigo-50 border border-indigo-200 px-2 py-1 text-indigo-800">
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 4v3M17 4v3M5 9h14M7 6h10a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V8a2 2 0 012-2z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
          <span>{{ j.date_posted }}</span>
        </span>
        {% endif %}
        {% if j.estimated_salary_range_compact %}
        <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 border border-amber-200 px-2 py-1 text-amber-800 font-semibold" title="Estimated salary range (experimental)">
          <span class="text-amber-700">Est.</span>
          <span>{{ (CUR.get(j.median_salary_currency) or '') }} {{ j.estimated_salary_range_compact }}</span>
        </span>
        {% endif %}
      </div>

      {% if loop.index == 1 and j.summary %}
      <div class="mt-2 text-slate-700 text-sm bg-slate-50 rounded-lg p-3 border border-slate-200">
        <strong>Summary:</strong> {{ j.summary }}
      </div>
      {% endif %}
    </div>
  </header>

  <!-- Description preview — always visible, uniquely truncated per card -->
  {% set desc_preview = desc_clean | truncate(220, True, '…') %}
  {% if desc_preview and desc_preview|length > 30 %}
  <p class="mt-2.5 text-sm text-slate-600 leading-relaxed line-clamp-3">{{ desc_preview }}</p>
  {% endif %}

  <!-- Full details toggle -->
  {% if desc_clean and desc_clean|length > 220 %}
  <details id="details-{{ j.id }}" class="mt-1 group">
    <summary aria-controls="details-{{ j.id }}" class="list-none inline-flex items-center gap-1 text-[13px] underline cursor-pointer text-slate-500 hover:text-brand focus:outline-none focus-visible:ring-2 focus-visible:ring-brand/50 py-0.5 rounded select-none">
      <span>Read full description</span>
      <svg class="w-3 h-3 transition-transform group-open:rotate-180 motion-safe:transition-transform" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
    </summary>
    <div class="mt-2">
      <p class="text-sm text-slate-700 whitespace-pre-line">{{ desc_clean }}</p>
    </div>
  </details>
  {% endif %}

  <!-- Actions -->
  <div class="mt-4 flex flex-col sm:flex-row gap-2">
  {% if card_index and card_index <= 2 %}
      {% if j.link %}
        <a
          href="{{ j.link }}"
          target="_blank"
          rel="noopener"
          data-title="{{ (j.title or '')|e }}"
          data-company="{{ (j.company or '')|e }}"
          data-location="{{ (j.location or 'Remote / Anywhere')|e }}"
          class="inline-flex items-center gap-2 rounded-md bg-gradient-to-b from-blue-600 to-blue-600/95 text-white px-4 py-2 text-sm font-semibold shadow-md hover:from-blue-700 hover:to-blue-700/95 transition-transform active:translate-y-px w-full sm:w-auto justify-center focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-300"
          aria-label="Easy apply for {{ j.title }} at {{ j.company }}"
        >
          <span class="sr-only">Easy Apply</span>
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v20M2 12h20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="ml-1">Easy Apply</span>
        </a>
      {% else %}
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-md bg-gradient-to-b from-blue-600 to-blue-600/95 text-white px-4 py-2 text-sm font-semibold shadow-md hover:from-blue-700 hover:to-blue-700/95 transition-transform active:translate-y-px w-full sm:w-auto justify-center focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-300"
          onclick="alert('No link available for this job yet')"
          aria-label="No external link available"
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="M12 2v20M2 12h20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="ml-1">Easy Apply</span>
        </button>
      {% endif %}
    {% else %}
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-md bg-brand text-white px-4 py-2 text-sm font-semibold shadow-md hover:bg-brand/90 transition-transform active:translate-y-px w-full sm:w-auto min-h-[44px] justify-center focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/50"
        data-apply
        data-title="{{ (j.title or '')|e }}"
        data-link="{{ (j.link or '')|e }}"
        data-company="{{ (j.company or '')|e }}"
        data-location="{{ (j.location or 'Remote / Anywhere')|e }}"
        data-description="{{ desc_clean|replace('\n', ' ')|truncate(200, True)|e }}"
        aria-label="Apply for {{ j.title }}"
      >
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>Apply</span>
      </button>
    {% endif %}
    <button
      type="button"
      class="inline-flex items-center gap-1.5 rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-600 hover:text-amber-600 hover:border-amber-300 transition w-full sm:w-auto min-h-[44px] justify-center focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/50"
      data-bookmark-btn
      data-job-id="{{ j.id }}"
      data-job-title="{{ (j.title or '')|e }}"
      data-job-company="{{ (j.company or '')|e }}"
      data-job-location="{{ (j.location or 'Remote / Anywhere')|e }}"
      data-job-link="{{ (j.link or '')|e }}"
      data-job-date="{{ j.date_posted or '' }}"
      aria-label="Save {{ (j.title or '')|e }}"
      aria-pressed="false"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M5 3h14a1 1 0 011 1v18l-7-4-7 4V4a1 1 0 011-1z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
      </svg>
      <span class="bookmark-label">Save</span>
    </button>
    <button
      type="button"
      class="inline-flex items-center gap-1.5 rounded-md border border-slate-200 px-3 py-2 text-sm text-slate-600 hover:text-violet-600 hover:border-violet-300 transition w-full sm:w-auto min-h-[44px] justify-center focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-violet-300/50"
      data-track-btn
      data-job-id="{{ j.id }}"
      data-job-title="{{ (j.title or '')|e }}"
      data-job-company="{{ (j.company or '')|e }}"
      data-job-location="{{ (j.location or 'Remote / Anywhere')|e }}"
      data-job-link="{{ (j.link or '')|e }}"
      aria-label="Track application for {{ (j.title or '')|e }}"
    >
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="track-label">Track</span>
    </button>
  </div>
</article>
