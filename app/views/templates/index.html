{% extends "base.html" %}
{% block title %}{% if title_q %}{{ title_q|capitalize }} Jobs{% if country_q %} in {{ country_q }}{% endif %} | Catalitium{% else %}Find Tech Jobs & Salary Insights | Catalitium{% endif %}{% endblock %}

{% block meta %}
<meta name="description" content="{% if title_q %}{{ title_q|capitalize }} jobs{% if country_q %} in {{ country_q }}{% endif %} with real salary data.{% else %}Search curated tech jobs with verified salary insights. Find your next role in AI, Development, Engineering across US, EU, UK & remote positions.{% endif %}">
<meta name="keywords" content="tech jobs, developer jobs, software engineer, remote work, {{ title_q if title_q else 'technology' }}, {{ country_q if country_q else 'remote jobs' }}">
<link rel="canonical" href="{{ url_for('index', _external=True) }}">
<!-- Open Graph tags -->
<meta property="og:title" content="{% if title_q %}{{ title_q|capitalize }} Jobs{% if country_q %} in {{ country_q }}{% endif %} | Catalitium{% else %}Find Tech Jobs & Salary Insights | Catalitium{% endif %}">
<meta property="og:description" content="{% if title_q %}Browse {{ title_q|capitalize }} jobs with real salary data{% else %}Search tech jobs with verified salary insights{% endif %}">
<meta property="og:type" content="website">
<meta property="og:url" content="{{ url_for('index', _external=True) }}">
<!-- Twitter Card tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{% if title_q %}{{ title_q|capitalize }} Jobs{% if country_q %} in {{ country_q }}{% endif %}{% else %}Tech Jobs & Salary Insights{% endif %}">
<meta name="twitter:description" content="{% if title_q %}Browse {{ title_q|capitalize }} jobs with real salary data{% else %}Search tech jobs with verified salary insights{% endif %}">
{% endblock %}

{% block content %}
<!-- HERO -->
<section class="pt-6 sm:pt-10" role="region" aria-labelledby="jobs-hero">
  <div class="mx-auto max-w-4xl text-center">
    <h1 id="jobs-hero" class="text-3xl sm:text-4xl font-semibold tracking-tight">
      {% if title_q %}
        {{ title_q|capitalize }} Jobs {% if country_q %}in {{ country_q }}{% endif %}
      {% else %}
        <span class="text-brand">Top Tech Jobs</span> with Salary Insights
      {% endif %}
    </h1>
    <p class="mt-3 text-slate-600">
      {% if title_q %}
        Browse {{ count|default(0) }} curated roles with real salary data
      {% else %}
        Search curated tech roles with free salary insights
      {% endif %}
    </p>
    {% if title_q and count > 0 %}
    <div class="mt-2 text-sm text-slate-500">
      Updated {{ "2025-11-02"|datetime|timeago }}
    </div>
    {% endif %}
  </div>

  <!-- SEARCH: What / Where -->
  <div class="mx-auto mt-6 max-w-4xl px-3 sm:px-0">
    <div class="sticky top-14 z-40 rounded-xl border border-slate-200 bg-white/95 backdrop-blur shadow-sm supports-[backdrop-filter]:bg-white/70 sm:static sm:border-transparent sm:bg-transparent sm:shadow-none">
      <form id="search"
            action="{{ url_for('index') }}"
            method="get"
            aria-label="Job search"
            role="search"
            aria-describedby="search-help"
            class="grid grid-cols-1 sm:grid-cols-[1fr_240px_auto] gap-2 sm:gap-3 p-3 sm:p-0"
            data-results-count="{{ count|default(0) }}">
        <p id="search-help" class="sr-only">Search jobs by title and country.</p>

        <label for="q" class="sr-only">Job title or keywords</label>
        <input id="q"
               name="title"
               value="{{ title_q or '' }}"
               type="search"
               inputmode="search"
               autocapitalize="none"
               spellcheck="false"
               autocomplete="off"
               placeholder="Enter job title or salary (e.g. developer, >100k)"
               class="w-full rounded-xl border border-slate-300 px-4 py-3 text-base sm:text-sm focus:ring-2 focus:ring-brand/50 focus:outline-none shadow-sm">

        <div id="loc-wrap" class="block">
          <label for="loc" class="sr-only">Country / region</label>
          <div class="relative">
            <input id="loc"
                   name="country"
                   value="{{ country_q or '' }}"
                   type="search"
                   inputmode="text"
                   autocapitalize="characters"
                   autocomplete="off"
                   placeholder="ðŸŒ Location (e.g. US, EU, London)"
                   class="w-full rounded-xl border border-slate-300 px-4 py-3 text-base sm:text-sm focus:ring-2 focus:ring-brand/50 focus:outline-none shadow-sm">
          </div>
        </div>

        <button type="submit"
                class="rounded-xl bg-brand text-white px-5 py-3.5 sm:py-3 font-medium text-base sm:text-sm hover:opacity-90 hover:shadow-md focus:ring-2 focus:ring-brand/50 focus:outline-none active:transform active:translate-y-[1px] transition shadow-sm"
                aria-label="Search {% if title_q %}{{ title_q }} {% endif %}jobs{% if country_q %} in {{ country_q }}{% endif %}">
          Search Jobs
        </button>
      </form>
    </div>
  </div>

  <!-- META / FILTERS -->
  <div class="mx-auto max-w-4xl mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3 px-3 sm:px-0">
    {% set show_exact = (title_q or country_q) %}
    {% set rounded = ((count // 1000) * 1000) if count and count >= 1000 else count %}
    <div class="flex items-center gap-2 flex-wrap text-xs sm:text-sm">
      <span class="font-medium text-slate-700">
        {% if show_exact %}
          {{ count|default(0) }} curated results
        {% else %}
          {% if rounded and rounded >= 1000 %}
            +{{ rounded }} curated results
          {% else %}
            {{ count|default(0) }} curated results
          {% endif %}
        {% endif %}
      </span>

      {% if title_q or country_q %}
      <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 border border-emerald-200 px-2 py-0.5 text-[11px] font-semibold text-emerald-800">
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7h16M9 12h6M11 17h2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Filters applied
      </span>
        {% if title_q %}
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-50 px-2.5 py-1 border border-slate-200 text-slate-700">
            <svg class="w-3.5 h-3.5 text-slate-500" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 7l-4 5 4 5M16 7l4 5-4 5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>
            title: {{ title_q }}
          </span>
        {% endif %}
        {% if country_q %}
          <span class="inline-flex items-center gap-1 rounded-full bg-slate-50 px-2.5 py-1 border border-slate-200 text-slate-700">
            <svg class="w-3.5 h-3.5 text-slate-500" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12c2.5-4 5.5-6 9-6s6.5 2 9 6c-2.5 4-5.5 6-9 6s-6.5-2-9-6z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 6c0 4 0 8 0 12" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
            country: {{ country_q }}
          </span>
        {% endif %}
        <a class="ml-1 underline hover:text-brand" href="{{ url_for('index') }}">Clear</a>
      {% endif %}
    </div>

    <!-- Subscribe toggle -->
    <label for="weekly-toggle" class="flex items-center gap-2 cursor-pointer select-none">
      <input id="weekly-toggle"
             type="checkbox"
             class="peer sr-only"
             aria-controls="subscribeDialog"
             aria-describedby="weekly-help">
      <span class="relative inline-flex h-5 w-9 items-center rounded-full bg-slate-300 peer-checked:bg-brand transition">
        <span class="absolute left-1 peer-checked:left-5 inline-block h-4 w-4 rounded-full bg-white shadow transition"></span>
      </span>
      <span class="text-slate-700">Subscribe for top jobs.</span>
    </label>
    <p id="weekly-help" class="sr-only">Opens the subscribe dialog so you can join the weekly newsletter.</p>
  </div>
  <div aria-live="polite" class="sr-only">
    {{ count|default(0) }} result{{ '' if count==1 else 's' }}
  </div>
</section>

<!-- Quick Filters -->
<div class="mx-auto max-w-4xl mt-3 sm:mt-4 px-3">
  <div class="flex items-center gap-2 mb-2 text-sm text-slate-600">
    <span class="inline-flex items-center gap-1 font-semibold text-slate-800">
      <svg class="w-4 h-4 text-slate-500" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7h16M7 12h10M10 17h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      Quick filters
    </span>
  </div>
  <div class="flex gap-2 sm:gap-3 overflow-x-auto no-scrollbar -mx-3 px-3 py-1.5 snap-x snap-mandatory touch-pan-x" role="listbox" aria-label="Quick filters">
    {% set t = (title_q or '') %}
    {% set c = (country_q or '') %}
    {% set base_chip = 'snap-start inline-flex items-center gap-1.5 rounded-full border px-3 py-1.5 text-sm font-medium transition focus-visible:ring-2 focus-visible:ring-brand/50 focus:outline-none' %}
    {% set off_chip = 'bg-slate-50 border-slate-200 text-slate-700 hover:bg-slate-100' %}
    {% set on_chip = 'bg-[#1061DE] text-white border-[#1061DE]' %}
    <a role="button" aria-pressed="{{ 'true' if 'ai' in (t|lower) else 'false' }}" href="{{ url_for('index', title=(t ~ ' ai').strip(), country=c) }}"
       data-filter-chip="title" data-filter-value="ai"
       class="{{ base_chip }} {{ on_chip if 'ai' in (t|lower) else off_chip }}">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 6.5h3M5 11.5h6M5 16.5h9" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><circle cx="15" cy="6.5" r="1.4" fill="currentColor"/><circle cx="12" cy="11.5" r="1.4" fill="currentColor"/><circle cx="9" cy="16.5" r="1.4" fill="currentColor"/></svg>
      AI
    </a>
    <a role="button" aria-pressed="{{ 'true' if 'developer' in (t|lower) else 'false' }}" href="{{ url_for('index', title=(t ~ ' developer').strip(), country=c) }}" data-filter-chip="title" data-filter-value="developer"
       class="{{ base_chip }} {{ on_chip if 'developer' in (t|lower) else off_chip }}">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 7l-4 5 4 5M16 7l4 5-4 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Dev
    </a>
    <a role="button" aria-pressed="{{ 'true' if 'remote' in (t|lower) else 'false' }}" href="{{ url_for('index', title=(t ~ ' remote').strip(), country=c) }}" data-filter-chip="title" data-filter-value="remote"
       class="{{ base_chip }} {{ on_chip if 'remote' in (t|lower) else off_chip }}">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 9a8 8 0 0116 0v6a2 2 0 01-2 2h-3l-2 3-2-3H6a2 2 0 01-2-2V9z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg>
      Remote
    </a>
    <a role="button" aria-pressed="{{ 'true' if 'senior' in (t|lower) else 'false' }}" href="{{ url_for('index', title=(t ~ ' senior').strip(), country=c) }}" data-filter-chip="title" data-filter-value="senior"
       class="{{ base_chip }} {{ on_chip if 'senior' in (t|lower) else off_chip }}">
      Senior
    </a>
    <a role="button" aria-pressed="{{ 'true' if '100k' in (t|lower) else 'false' }}" href="{{ url_for('index', title=(t ~ ' 100k').strip(), country=c) }}" data-filter-chip="title" data-filter-value=">100k"
       class="{{ base_chip }} {{ on_chip if '100k' in (t|lower) else off_chip }}">
      >100k
    </a>
    <a role="button" aria-pressed="{{ 'true' if c=='CH' else 'false' }}" href="{{ url_for('index', title=t, country='CH') }}" data-filter-chip="country" data-filter-value="CH"
       class="{{ base_chip }} {{ on_chip if c=='CH' else off_chip }}">
      CH
    </a>
    <a role="button" aria-pressed="{{ 'true' if c=='EU' else 'false' }}" href="{{ url_for('index', title=t, country='EU') }}" data-filter-chip="country" data-filter-value="EU"
       class="{{ base_chip }} {{ on_chip if c=='EU' else off_chip }}">
      EU
    </a>
    <a role="button" aria-pressed="{{ 'true' if c=='UK' else 'false' }}" href="{{ url_for('index', title=t, country='UK') }}" data-filter-chip="country" data-filter-value="UK"
       class="{{ base_chip }} {{ on_chip if c=='UK' else off_chip }}">
      UK
    </a>
    <a role="button" aria-pressed="{{ 'true' if c=='US' else 'false' }}" href="{{ url_for('index', title=t, country='US') }}" data-filter-chip="country" data-filter-value="US"
       class="{{ base_chip }} {{ on_chip if c=='US' else off_chip }}">
      US
    </a>
    <a role="button" aria-pressed="{{ 'true' if c=='IN' else 'false' }}" href="{{ url_for('index', title=t, country='IN') }}" data-filter-chip="country" data-filter-value="IN"
       class="{{ base_chip }} {{ on_chip if c=='IN' else off_chip }}">
      IN
    </a>
  </div>
  <div class="sr-only" aria-live="polite">Quick filters</div>
</div>

<!-- RESULTS LIST -->
<section class="mx-auto max-w-4xl mt-6" aria-label="Job results">
  <div id="results" class="grid grid-cols-1 gap-3">
    {% if results and results|length > 0 %}
      {% for j in results %}
        {% set card_index = loop.index %}
        {% include 'components/job_card.html' %}
        {% if loop.index == 3 %}
          {% set promo_body -%}
            Get more jobs <a href="#" class="underline" data-open-subscribe>Receive insights weekly</a>.
          {%- endset %}
          {% with %}
            {% set params = {
              'eyebrow': 'Top Jobs',
              'body': promo_body,
              'subcopy': 'See free insights below.',
              'background_class': 'bg-blue-50',
              'border_class': 'border-blue-300/60',
              'text_class': 'text-blue-800'
            } %}
            {% include 'components/promo_card.html' with context %}
          {% endwith %}
        {% endif %}
        {% if loop.index == 7 %}
          {% set promo_body -%}
            Your job here. Reach top talent. <a href="#" class="underline" data-open-subscribe>Contact us</a>.
          {%- endset %}
          {% with %}
            {% set params = {
              'eyebrow': 'Sponsored',
              'body': promo_body,
              'background_class': 'bg-amber-50',
              'border_class': 'border-amber-300/60',
              'text_class': 'text-amber-800'
            } %}
            {% include 'components/promo_card.html' with context %}
          {% endwith %}
        {% endif %}
      {% endfor %}
    {% else %}
      <div class="rounded-xl border border-slate-200 p-6 text-slate-600 text-center">
        <p class="font-medium">No jobs found.</p>
        <p class="text-xs mt-1">Try broader keywords (e.g., engineer, pm) or another region (e.g., CH, EU, UK, US).</p>
      </div>
    {% endif %}
  </div>
  <!-- Skeletons shown during form submit navigation -->
  <div id="results-skeletons" class="mt-3 hidden">
    <div class="rounded-xl border border-slate-200 p-4 animate-pulse h-24 bg-slate-50"></div>
    <div class="rounded-xl border border-slate-200 p-4 animate-pulse h-24 bg-slate-50 mt-2"></div>
    <div class="rounded-xl border border-slate-200 p-4 animate-pulse h-24 bg-slate-50 mt-2"></div>
    <div class="rounded-xl border border-slate-200 p-4 animate-pulse h-24 bg-slate-50 mt-2"></div>
  </div>
</section>

<!-- Pagination -->
{% if pagination and (pagination.has_prev or pagination.has_next) %}
<nav class="mx-auto max-w-4xl mt-4 flex items-center justify-between text-sm"
     role="navigation" aria-label="Pagination">
  <a rel="prev" aria-disabled="{{ 'false' if pagination.has_prev else 'true' }}" tabindex="{{ '0' if pagination.has_prev else '-1' }}" class="px-3 py-2 rounded-lg border border-slate-200 hover:border-brand {{ '' if pagination.has_prev else 'pointer-events-none opacity-50' }}"
     href="{{ pagination.prev_url or '#' }}">? Prev</a>
  <span class="text-slate-500">
    Page {{ pagination.page }} of {{ pagination.pages }}  {{ pagination.total }} total
  </span>
  <a rel="next" aria-disabled="{{ 'false' if pagination.has_next else 'true' }}" tabindex="{{ '0' if pagination.has_next else '-1' }}" class="px-3 py-2 rounded-lg border border-slate-200 hover:border-brand {{ '' if pagination.has_next else 'pointer-events-none opacity-50' }}"
     href="{{ pagination.next_url or '#' }}">Next</a>
</nav>
{% endif %}

<!-- Subscribe dialog is defined globally in base.html -->
{% endblock %}

{% block body_extra %}
<!-- Structured Data for Job Search -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "url": "{{ url_for('index', _external=True) }}",
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": "{{ url_for('index', _external=True) }}?title={search_term_string}"
    },
    "query-input": "required name=search_term_string"
  }
}
</script>
{% if results and results|length > 0 %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "itemListElement": [
    {% for j in results %}
    {
      "@type": "ListItem",
      "position": {{ loop.index }},
      "item": {
        "@type": "JobPosting",
        "title": "{{ j.title|e }}",
        "description": "{{ j.description|truncate(200, True)|e }}",
        "datePosted": "{{ j.date }}",
        "employmentType": "FULL_TIME",
        "hiringOrganization": {
          "@type": "Organization",
          "name": "{{ j.company|e if j.company else 'Company' }}"
        },
        "jobLocation": {
          "@type": "Place",
          "address": {
            "@type": "PostalAddress",
            "addressLocality": "{{ j.location|e }}"
          }
        }{% if j.estimated_salary_range_compact %},
        "estimatedSalary": {
          "@type": "MonetaryAmount",
          "currency": "{{ j.median_salary_currency }}",
          "value": {
            "@type": "QuantitativeValue",
            "minValue": {{ j.salary_min if j.salary_min else "null" }},
            "maxValue": {{ j.salary_max if j.salary_max else "null" }},
            "unitText": "YEAR"
          }
        }{% endif %}
      }
    }{{ "," if not loop.last }}
    {% endfor %}
  ]
}
</script>
{% endif %}

<script>
(() => {
  const form = document.getElementById('search');
  const results = document.getElementById('results');
  const skeletons = document.getElementById('results-skeletons');
  const chips = document.querySelectorAll('[data-filter-chip]');
  const titleInput = document.getElementById('q');
  const countryInput = document.getElementById('loc');

  const showSkeleton = () => {
    if (skeletons && results) {
      skeletons.classList.remove('hidden');
      results.classList.add('opacity-60');
    }
  };

  if (form) {
    form.addEventListener('submit', () => {
      try {
        localStorage.setItem('last_title', titleInput?.value || '');
        localStorage.setItem('last_country', countryInput?.value || '');
      } catch (_) {}
      showSkeleton();
    });
  }

  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      try {
        localStorage.setItem('last_title', titleInput?.value || '');
        localStorage.setItem('last_country', countryInput?.value || '');
      } catch (_) {}
      showSkeleton();
    });
  });

  // Restore last search on landing if fields are empty
  try {
    const savedTitle = localStorage.getItem('last_title') || '';
    const savedCountry = localStorage.getItem('last_country') || '';
    if (titleInput && !titleInput.value && savedTitle) titleInput.value = savedTitle;
    if (countryInput && !countryInput.value && savedCountry) countryInput.value = savedCountry;
  } catch (_) {}
})();
</script>
{% endblock %}
</attachment>
